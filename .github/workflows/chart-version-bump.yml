# Copyright The Linux Foundation and each contributor to LFX.
# SPDX-License-Identifier: MIT
---
# Automatically create a new pull-request to bump the Chart.yaml version on
# merges to the default branch
name: Chart Version Bump

"on":
  push:
    branches:
      - main
    paths:
      - 'charts/**'

permissions:
  contents: write
  pull-requests: write
  id-token: write

# On merges to the default branch:
#   Create a commit to bump the version in Chart.yaml and create a PR
#   (skipped if Chart.yaml version was manually modified)
jobs:
  check-chart-version:
    name: Check Chart Version and Create PR
    runs-on: ubuntu-latest
    # Because this workflow both modifies and is triggered off of
    # changes to Chart.yaml, a commit message tag '[skip-version-bump]'
    # is used to prevent loops
    if: "!contains(github.event.head_commit.message, '[skip-version-bump]')"
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v4
        with:
          fetch-depth: 2
          fetch-tags: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Prepare versions and chart name
        id: prepare
        run: |
          set -euo pipefail
          CHART_NAME="$(yq '.name' charts/*/Chart.yaml)"
          CHART_FILE="charts/$CHART_NAME/Chart.yaml"
          CHART_VERSION="$(yq '.version' charts/*/Chart.yaml)"
          {
            echo "chart_file=$CHART_FILE"
            echo "chart_version=$CHART_VERSION"
          } >> "$GITHUB_OUTPUT"

      - name: Check if Chart.yaml version was manually modified
        id: check-version-change
        run: |
          set -euo pipefail

          # Get the list of modified files in this push
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)

          # Check if Chart.yaml was modified
          if echo "$CHANGED_FILES" | grep -q "charts/.*/Chart.yaml"; then
            echo "Chart.yaml was modified in this push"

            # Check if the version field specifically was changed
            VERSION_DIFF=$(git diff HEAD^ HEAD -- charts/*/Chart.yaml | grep "^[+-]version:" || true)

            if [ -n "$VERSION_DIFF" ]; then
              echo "Version was manually modified in Chart.yaml"
              echo "version_changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "Chart.yaml changed but version was not modified"
              echo "version_changed=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "Chart.yaml was not modified, proceeding with auto-bump"
            echo "version_changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump patch version
        if: steps.check-version-change.outputs.version_changed == 'false'
        id: bump
        run: |
          set -euo pipefail

          CHART_FILE="${{ steps.prepare.outputs.chart_file }}"

          # Get current version
          CURRENT_VERSION="${{ steps.prepare.outputs.chart_version }}"
          echo "Current version: $CURRENT_VERSION"

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Bump patch version
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
          echo "New version: $NEW_VERSION"

          # Update Chart.yaml
          yq -i ".version = \"$NEW_VERSION\"" "$CHART_FILE"

          # Output for next steps
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "current_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        if: steps.check-version-change.outputs.version_changed == 'false'
        id: cpr
        uses: peter-evans/create-pull-request@v7
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        with:
          body: |
            Automated patch version bump for Helm chart.

            - Current version: ${{ steps.bump.outputs.current_version }}
            - New version: ${{ steps.bump.outputs.new_version }}
          commit-message: |
            chore(helm): bump chart version to ${{ steps.bump.outputs.new_version }} [skip-version-bump]

            Automated patch version bump for Helm chart.
          branch: chart-version-bump-${{ steps.bump.outputs.new_version }}
          draft: false
          signoff: true
          sign-commits: true
          title: "chore(helm): bump chart version to ${{ steps.bump.outputs.new_version }}"
          labels: |
            automated

      - name: Enable Auto Merge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          gh pr merge --merge --auto "${{ steps.cpr.outputs.pull-request-number }}"
